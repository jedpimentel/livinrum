<!DOCTYPE html> 
<html>
  <head>
    <title>LIVINRUM</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style type="text/css"></style>

    <!-- https://github.com/mayognaise/aframe-gif-shader -->
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <!-- gif fixer: -->
    <!-- link to pull request that hasn't been merged -->
    <!-- https://github.com/mayognaise/aframe-gif-shader/pull/15 -->
    <script type="text/javascript">
      AFRAME.registerComponent('gif-fixer', {
        tock: function () {
          // patch gif logic on first tock so shader is already loaded
          this.fix();
          this.tock = function () {};
        },
        fix: function () {
          const shader = this.el.components.material.shader
          const existingLogic = shader.nextFrame
          const newVer = aaa => {
            // canvas was not being cleared between gif frames
            shader.__clearCanvas();
            existingLogic.apply(this.el.components.material.shader)
          }
          shader.nextFrame = newVer;
        }
      })

      // // experimental
      // // sends positional data to websocket, leading 
      // // is tick better, or tock better?
      // AFRAME.registerComponent('tracked-head', {

      //   tick: function () {
      //     // update location of non-local networked entities
      //   },
      // })

      // AFRAME.registerComponent('websocket-receiver',)
    </script>

  </head>
  <body style="font-family:courier; color:white; background-color: black">

    <section id="main">
      <button id="download-button">DOWNLOAD</button>
      upload images:
      <input id="file-input" type="file" multiple name="">
    </section>

    <a-scene ar embedded id="scene" vr-mode-ui="enabled: true">
      <!-- test, somehow my last commit isn't showing in my github history -->

      <a-assets>
        <img id="fire" src="fire.gif">
      </a-assets>

      <a-entity>
        <a-camera look-controls="pointerLockEnabled: false" wasd-controls></a-camera>
        <a-entity cursor="rayOrigin: mouse" raycaster="objects:.clickable"></a-entity>
      </a-entity>
      <a-image src="livinrum.jpg" opacity="0.5" position="0 0 -1000" height="1609.34" width="1609.34"></a-image>
      <a-box id='test' gif-fixer material="shader:gif;src:url(fire.gif);" transparent="true" position="-4 1.6 19"></a-box>

      <a-image src="flyer.png" position="-1 1.5 0" rotation="0 90 0"></a-image>
      <a-entity id="image-strip" position='-1 1.6 -2'></a-entity>
      <a-entity id="environment-element" position='5 0 10' rotation="0 -90 0"></a-entity>
    </a-scene>

    <script type="text/javascript" src="lib/composition-handler.js"></script>
    <script type="module" src="lib/environment-generator.js"></script>


    <script type="text/javascript">
      
      // var socket = new WebSocket('ws://localhost:8082/');//TOFO: use server IP (programmatically)
      // var socket = new WebSocket(`ws://${location.hostname}:8082/`);//TODO: use server IP (programmatically)
      const socket = new WebSocket(`ws://localhost:8082/`);//TODO: use server IP (programmatically)

      socket.onerror = function(error) {
        console.log('WebSocket Error: ', error);
      };
      socket.onopen = function(event) {
        console.log('opened socket')
        console.log('Connected to: ' + event.currentTarget.url);


        const camera = document.querySelector("a-camera");

        // debugger
        
        // IMPORTANT: ids are pseudo-unique,
        // backend should handle IDs versus using random throws
        const self_id = BigInt(Math.floor(Number.MAX_SAFE_INTEGER * Math.random()));

        // [id (uint), timestamp(uint), posx(float64), posy, posz, rotx(float64), roty, rotz]
        // 8 8-byte values
        const buffer = new ArrayBuffer(8*8*8);
        const uint64Buffer = new BigUint64Array(buffer, 0, 8*2);
        const float64Buffer = new Float64Array(buffer, 8*2, 8*6);

        uint64Buffer[0] = self_id;

        setInterval(() => {



          float64Buffer[0] = camera.object3D.position.x;
          float64Buffer[1] = camera.object3D.position.y;
          float64Buffer[2] = camera.object3D.position.z;
          float64Buffer[3] = camera.object3D.rotation.x;
          float64Buffer[4] = camera.object3D.rotation.y;
          float64Buffer[5] = camera.object3D.rotation.z;

          // const pos = camera.object3D.position;
          // const rot = camera.object3D.rotation;

          socket.send(buffer)

          // socket.send(id)

        }, 1000/1)
        
        // document.querySelector("#ping").onclick = () => {
        //   socket.send('ping')
        // }


        // const msg = document.querySelector('#message');
        // document.querySelector("#message-form").addEventListener("submit", event => {
        //   socket.send(socket.send);
        //   msg.value = "";
        // })

      }


      // const buffer = new ArrayBuffer(8*8*8);
      // const uint64Buffer = new BigUint64Array(buffer, 0, 8*2);
      // const float64Buffer = new Float64Array(buffer, 8*2, 8*6);
      // Handle messages sent by the server.
      const networked_entities = new Map()
      const entity_wrapper = document.querySelector('a-scene')

      socket.binaryType = 'arraybuffer';
      socket.onmessage = function(event) {
        // console.log(event)
        // return
        const data = event.data
        console.log(data)


        // TODO: is performance impact of re-initializing thi every message?
        const uint64Buffer = new BigUint64Array(data, 0, 8*2);
        const float64Buffer = new Float64Array(data, 8*2, 8*6);

        const entity_number = uint64Buffer[0];
        // if (entity_number === self_id) return;// this is an echo/pong message... do something with these?
        if (!networked_entities.has(entity_number)) {
          console.log('aaaaaa', entity_number)
          const box = document.createElement("a-box"); 
          entity_wrapper.appendChild(box)
          networked_entities.set(entity_number, box)
        }


        // const entity_timestamp = uint64Buffer[1];
        const posX = float64Buffer[0];
        // const posY = float64Buffer[1];
        // const posZ = float64Buffer[2] -2;
        // const rotX = float64Buffer[3];
        // const rotY = float64Buffer[4];
        // const rotZ = float64Buffer[5];

        const box = networked_entities.get(entity_number)
        box.object3D.position.x = posX;
        // box.object3D.position.y = posY;
        // box.object3D.position.z = posZ;
        window.box = box

        // console.log('message', event)
      };
      // Show a disconnected message when the WebSocket is closed.
      socket.onclose = function(event) {
        console.log('close', event)
      };
    </script>
  </body>
</html>
